import{readFileSync as e,readdirSync as t,statSync as r,existsSync as o}from"fs";import{join as n,resolve as l}from"path";import a from"gray-matter";export default class i{static generateSidebar(e){const t=Array.isArray(e)?e:[e],r={},o=Array.isArray(e);let l,a=!1;for(let e=0;e<t.length;e+=1){const o=t[e];if(Object.keys(o).length>0){if(o.root)throw new Error(i.generateDeprecateMessage("root","documentRootPath"));if(o.withIndex)throw new Error(i.generateDeprecateMessage("withIndex","includeRootIndexFile"));if(o.includeEmptyGroup)throw new Error(i.generateDeprecateMessage("includeEmptyGroup","includeEmptyFolder"));if(o.sortByFileName)throw new Error(i.generateDeprecateMessage("sortByFileName","manualSortFileNameByPriority"));if(o.useFolderLinkAsIndexPage)throw new Error(i.generateDeprecateMessage("useFolderLinkAsIndexPage","useIndexFileForFolderMenuInfo"));if(o.useIndexFileForFolderMenuInfo)throw new Error(i.generateDeprecateMessage("useIndexFileForFolderMenuInfo","useFolderTitleFromIndexFile` and `useFolderLinkFromIndexFile"));if(o.sortMenusByFrontmatterOrder&&o.sortMenusByName)throw new Error(i.generateNotTogetherMessage("sortMenusByFrontmatterOrder","sortMenusByName"));if(o.sortMenusByFrontmatterOrder&&o.sortMenusOrderNumerically)throw new Error(i.generateNotTogetherMessage("sortMenusByFrontmatterOrder","sortMenusOrderNumerically"));o.debugPrint&&!a&&(a=!0),o.documentRootPath=o?.documentRootPath??"/",/^\//.test(o.documentRootPath)||(o.documentRootPath=`/${o.documentRootPath}`),o.collapseDepth&&(o.collapsed=!0),o.collapseDepth=o?.collapseDepth??1,o.manualSortFileNameByPriority=o?.manualSortFileNameByPriority??[],o.excludeFiles=o?.excludeFiles??[],o.excludeFolders=o?.excludeFolders??[],o.frontmatterOrderDefaultValue=o?.frontmatterOrderDefaultValue??0;let e=o.documentRootPath;o.scanStartPath&&(e=`${o.documentRootPath}/${o.scanStartPath}`.replace(/\/{2,}/g,"/").replace("/$",""));const t=i.generateSidebarItem(1,n(process.cwd(),e),e,null,o);r[o.resolvePath||"/"]={base:o.resolvePath||"/",items:t?.items||(o.rootGroupText||o.rootGroupLink||!0===o.rootGroupCollapsed||!1===o.rootGroupCollapsed?[{text:o.rootGroupText,...o.rootGroupLink?{link:o.rootGroupLink}:{},items:t,...null===o.rootGroupCollapsed?{}:{collapsed:o.rootGroupCollapsed}}]:t)}}}return l=o||1!==Object.keys(r).length?r:Object.values(r)[0].items,a&&process.stdout.write(`\n${"=".repeat(50)}\n${JSON.stringify(t,null,2)}\n${"-".repeat(50)}\n${JSON.stringify(l,null,2)}\n${"=".repeat(50)}\n\n`),l}static generateDeprecateMessage(e,t){return`The \`${e}\` option was renamed to \`${t}\`.`}static generateNotTogetherMessage(e,t){return`The \`${e}\` and \`${t}\` options cannot be used together.`}static generateSidebarItem(e,n,a,s,d){let c=t(n);if(d.manualSortFileNameByPriority.length>0){const e=c.filter((e=>-1!==d.manualSortFileNameByPriority?.indexOf(e))),t=c.filter((e=>-1===d.manualSortFileNameByPriority?.indexOf(e)));e.sort(((e,t)=>d.manualSortFileNameByPriority.indexOf(e)-d.manualSortFileNameByPriority.indexOf(t))),c=[...e,...t]}let u=c.map((t=>{const c=l(n,t);let u=`${a}/${t}`.replace(/\/{2}/,"/").replace(/\.md$/,"");if(d.documentRootPath&&u.startsWith(d.documentRootPath)&&(u=u.replace(new RegExp(`^${d.documentRootPath}`,"g"),""),d.scanStartPath||d.resolvePath?(u=u.replace(/^\//g,""),d.scanStartPath&&(u=u.replace(new RegExp(`^${d.scanStartPath}`,"g"),"")),u=u.replace(/^\//g,"")):u.startsWith("/")||(u=`/${u}`)),/\.vitepress/.test(c))return null;if(1===e&&"index.md"===t&&!d.includeRootIndexFile)return null;if(1!==e&&"index.md"===t&&!d.includeFolderIndexFile)return null;if(!d.includeDotFiles&&/^\./.test(t))return null;if(r(c).isDirectory()){if(d.excludeFolders?.includes(t))return null;let r,n=i.generateSidebarItem(e+1,c,u,t,d)||[],a=i.getTitleFromMd(t,c,d,!0),s=c;if(d.convertSameNameSubFileToGroupIndexPage){const e=n.find((e=>e.text===t));e&&(s=l(c,`${e.text}.md`),a=i.getTitleFromMd(t,s,d,!1),r=d.folderLinkNotIncludesFileName?u:e.link,n=n.filter((e=>e.text!==t)))}else s=`${c}/index.md`,o(s)&&(d.useFolderTitleFromIndexFile&&(a=i.getTitleFromMd("index",s,d)),d.useFolderLinkFromIndexFile&&(r=`${u}/`));return d.includeEmptyFolder||n.length>0?{text:a,...r?{link:r}:{},items:n,...null===d.collapsed||void 0===d.collapsed?{}:{collapsed:e>=d.collapseDepth&&d.collapsed},...d.sortMenusByFrontmatterOrder?{order:i.getOrderFromFrontmatter(s,d.frontmatterOrderDefaultValue)}:{}}:null}if(c.endsWith(".md")){if(d.excludeFiles?.includes(t))return null;let e;const r=t.replace(/\.md$/,"");return e=d.convertSameNameSubFileToGroupIndexPage&&s===r?r:i.getTitleFromMd(t,c,d),{text:e,link:u,...d.sortMenusByFrontmatterOrder?{order:i.getOrderFromFrontmatter(c,d.frontmatterOrderDefaultValue)}:{}}}return null})).filter((e=>null!==e));return d.sortMenusByName&&(u=i.sortByObjectKey(u,"text",d.sortMenusOrderByDescending)),d.sortMenusByFrontmatterOrder&&(u=i.sortByObjectKey(u,"order",d.sortMenusOrderByDescending),i.deepDeleteKey(u,"order")),d.sortMenusOrderNumerically&&(u=i.sortByObjectKey(u,"text",d.sortMenusOrderByDescending,!0)),u}static getOrderFromFrontmatter(t,r){try{const r=e(t,"utf-8"),{data:o}=a(r);if(o?.order)return parseInt(o?.order,10);const n=r.split("\n");let l=!1;for(let e=0,t=n.length;e<t;e+=1){const t=n[e].toString().replace("\r","");if(/^---$/.test(t)&&(l=!0),/^order: (.*)/.test(t)&&l)return parseInt(t.replace("order: ",""),10)}}catch(e){return r}return r}static capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}static formatTitle(e,t){let r=t;if(e.hyphenToSpace&&(r=r.replace(/-/g," ")),e.underscoreToSpace&&(r=r.replace(/_/g," ")),e.capitalizeEachWords){const e=r.trim().toLowerCase().split(" ");for(let t=0;t<e.length;t+=1)e[t]=i.capitalizeFirst(e[t]);r=e.join(" ")}else e.capitalizeFirst&&(r=i.capitalizeFirst(r));return r}static getTitleFromMd(t,r,o,n=!1){if(n)return i.formatTitle(o,t);if(o.useTitleFromFrontmatter)try{const t=e(r,"utf-8"),{data:n}=a(t);if(n?.title)return i.formatTitle(o,n.title.toString());const l=t.split("\n");let s=!1;for(let e=0,t=l.length;e<t;e+=1){let t=l[e].toString().replace("\r","");if(/^---$/.test(t)&&(s=!0),/^title: (.*)/.test(t)&&s)return t=t.replace("title: ",""),i.formatTitle(o,t)}}catch{return"Unknown"}if(o.useTitleFromFileHeading)try{const t=e(r,"utf-8").split("\n");for(let e=0,r=t.length;e<r;e+=1){let r=t[e].toString().replace("\r","");if(/^# /.test(r)){if(r=r.replace(/^# /,""),/\[(.*)]\(.*\)/.test(r)){const e=/(.*)?\[(.*)]\((.*)\)(.*)?/.exec(r)||"";r=e.length>0?`${e[1]||""}${e[2]||""}${e[4]||""}`:""}return o.keepMarkdownSyntaxFromTitle||(r=r.replace(/\*{1,2}([^*]+?)\*{1,2}/g,"$1"),r=r.replace(/_{1,2}([^_]+?)_{1,2}/g,"$1"),r=r.replace(/~{1,2}([^~]+?)~{1,2}/g,"$1"),r=r.replace(/`{1,3}([^`]+?)`{1,3}/g,"$1")),i.formatTitle(o,r)}}}catch{return"Unknown"}return i.formatTitle(o,t.replace(/\.md$/,""))}static sortByObjectKey(e,t,r=!1,o=!1){for(let n=0;n<e.length;n+=1)e[n].items&&e[n].items.length&&(e[n].items=i.sortByObjectKey(e[n].items,t,r,o));if(o){const o=new Intl.Collator([],{numeric:!0}),n=e.sort(((e,r)=>o.compare(e[t],r[t])));return r?n.reverse():n}return e.sort(((e,o)=>r?e[t]>o[t]?-1:e[t]<o[t]?1:0:e[t]<o[t]?-1:e[t]>o[t]?1:0))}static deepDeleteKey(e,t){"object"==typeof e&&null!==e&&(Object.hasOwn(e,t)&&delete e[t],Object.keys(e).forEach((r=>{"object"==typeof e[r]&&i.deepDeleteKey(e[r],t)})))}}export{i as VitePressSidebar};export const{generateSidebar:generateSidebar}=i;